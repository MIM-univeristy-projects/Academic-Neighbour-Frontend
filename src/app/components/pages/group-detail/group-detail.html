<div class="min-h-screen bg-linear-to-b from-gray-50 to-gray-100">
    <!-- Navigation Header -->
    <app-feed-header></app-feed-header>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 pt-8 pb-8 sm:px-6 lg:px-8">

        @if (isLoading()) {
        <div class="flex flex-col items-center justify-center p-16">
            <div class="w-16 h-16 border-4 border-gray-200 border-t-amber-500 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-600 font-medium">Ładowanie grupy...</p>
        </div>
        }

        @if (hasError()) {
        <div class="flex flex-col items-center justify-center p-8 bg-red-50 rounded-2xl border border-red-200">
            @if (isRedirecting()) {
            <mat-icon class="text-amber-500 text-5xl mb-3">lock</mat-icon>
            <p class="text-amber-700 font-semibold mb-2">{{ errorMessage() }}</p>
            <div class="flex items-center gap-2 text-amber-600">
                <div class="w-5 h-5 border-2 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
                <span>Przekierowywanie do logowania...</span>
            </div>
            } @else {
            <mat-icon class="text-red-500 text-5xl mb-3">error_outline</mat-icon>
            <p class="text-red-700 font-semibold mb-2">{{ errorMessage() }}</p>
            <button mat-raised-button color="primary" (click)="goBack()">
                <mat-icon>arrow_back</mat-icon>
                <span class="ml-2">Wróć do grup</span>
            </button>
            }
        </div>
        }

        @if (!isLoading() && group() && !hasError()) {
        <!-- Group Header -->
        <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <button mat-icon-button (click)="goBack()" class="shrink-0">
                    <mat-icon>arrow_back</mat-icon>
                </button>

                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ group()!.name }}</h1>
                    <p class="text-gray-600 mb-4">{{ group()!.description }}</p>

                    <div class="flex items-center gap-4 text-sm text-gray-500">
                        <span class="flex items-center gap-1">
                            <mat-icon class="text-base!">calendar_today</mat-icon>
                            Utworzona {{ group()!.created_at | date:'short' }}
                        </span>
                        <button (click)="toggleMembersView()"
                            class="flex items-center gap-1 hover:text-amber-600 transition-colors">
                            <mat-icon class="text-base!">people</mat-icon>
                            {{ group()!.member_count || 0 }} {{ group()!.member_count === 1 ? 'członek' : 'członków' }}
                        </button>
                    </div>
                </div>

                <div class="shrink-0">
                    @if (isMember()) {
                    <button mat-raised-button (click)="onLeaveGroup()" class="bg-red-500 text-white hover:bg-red-600">
                        <mat-icon>exit_to_app</mat-icon>
                        <span class="ml-2">Opuść grupę</span>
                    </button>
                    } @else {
                    <button mat-raised-button (click)="onJoinGroup()"
                        class="bg-amber-500 text-white hover:bg-amber-600">
                        <mat-icon>group_add</mat-icon>
                        <span class="ml-2">Dołącz do grupy</span>
                    </button>
                    }
                </div>
            </div>

            <!-- Members List -->
            @if (showMembers()) {
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h3 class="font-semibold text-gray-900 mb-3">Członkowie grupy</h3>
                @if (isLoadingMembers()) {
                <div class="flex justify-center p-4">
                    <mat-spinner diameter="30"></mat-spinner>
                </div>
                } @else {
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    @for (member of members(); track member.id; let index = $index) {
                    <button (click)="navigateToProfile(member.id)"
                        class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-left">
                        <div
                            [class]="'w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold shrink-0 ' + getGradientClass(index)">
                            {{ getInitials(member) }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 truncate">
                                {{ member.first_name }} {{ member.last_name }}
                            </p>
                            <p class="text-xs text-gray-500 truncate">@{{ member.username }}</p>
                        </div>
                    </button>
                    }
                </div>
                }
            </div>
            }
        </div>

        <!-- Create Post Form (only for members) -->
        @if (isMember()) {
        <div class="mb-6">
            <app-create-post-form (createPost)="onCreatePost($event)"></app-create-post-form>
        </div>
        }

        <!-- Posts Section -->
        <div class="space-y-4">
            @if (isLoadingPosts()) {
            <div class="flex flex-col items-center justify-center p-16 bg-white rounded-2xl shadow-md">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-amber-500 rounded-full animate-spin mb-4"></div>
                <p class="text-gray-600 font-medium">Ładowanie postów...</p>
            </div>
            }

            @if (!isLoadingPosts() && !hasPosts()) {
            <div class="flex flex-col items-center justify-center p-16 bg-white rounded-2xl shadow-md">
                <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                    <mat-icon class="text-gray-400 text-5xl! w-12! h-12!">post_add</mat-icon>
                </div>
                <p class="text-xl font-semibold text-gray-700 mb-2">Brak postów</p>
                <p class="text-sm text-gray-500">
                    @if (isMember()) {
                    Bądź pierwszy i dodaj post do tej grupy!
                    } @else {
                    Dołącz do grupy, aby zobaczyć i dodawać posty.
                    }
                </p>
            </div>
            }

            @if (!isLoadingPosts() && hasPosts()) {
            @for (post of posts(); track post.id) {
            <app-post [post]="post" (likePost)="onLikePost($event)" (refreshPost)="onRefreshPost()"></app-post>
            }
            }
        </div>
        }
    </div>
</div>